#!/usr/bin/env bash

set -o errexit

export user_id=${HABITICA_USER_ID:?"habitica user id is not set"}
export api_token=${HABITICA_API_TOKEN?"habitica api token is not set"}
export x_client_header=${X_CLIENT_HEADER:?x_client_header not set}
domain="https://habitica.com"
export api_version="v3"
export api_base_url="${domain}/api/${api_version}"

print_script_dir() {
  this_script=$(perl -e 'use Cwd "abs_path"; print abs_path(shift)' "$0")
  this_script_dir=$(dirname "${this_script}")
  echo "${this_script_dir}"
}
script_dirname=$(print_script_dir)

handle_global_options() {
  if [[ "$1" == "--help" ]]; then
    cat "${script_dirname}/hopla.help"
    exit 0
  fi

  if [[ "$1" == "--version" ]]; then
    cat "${script_dirname}/hopla.version"
    exit 0
  fi
}
handle_global_options "$@"

command_file="${script_dirname}"
command_counter=1
while [[ -d "${command_file}" && "${command_counter}" -le $# ]]; do
  command_file="${command_file}/${!command_counter}"
  command_counter=$((command_counter + 1))
done


#echo "file to be executed: ${command_file}"
#echo "commands to be passed: ${*:$command_counter}"

arguments="${*:$command_counter}"

"${command_file}" "${arguments}"






## quick test stuff

test_api_call() {
  curl --verbose "${api_base_url}/user" -XGET --compressed \
    --header "application/json" \
    --header "x-api-user: ${user_id}" \
    --header "x-api-key: ${api_token}" \
    --header "x-client ${x_client_header}"
}
#test_api_call




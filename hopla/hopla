#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

print_script_dir() {
  declare -r this_script=$(perl -e 'use Cwd "abs_path"; print abs_path(shift)' "$0")
  declare -r this_script_dir=$(dirname "${this_script}")
  echo "${this_script_dir}"
}

print_library_dir() {
  declare -r script_dirname="$(print_script_dir)"
  declare -r library_dirname="$(realpath "${script_dirname}/../library/")"
  echo "${library_dirname}"
}

declare -xr library_dir=$(print_library_dir)
source "${library_dir}/api_proxy.sh"
source "${library_dir}/logging.sh"
source "${library_dir}/load_config.sh"
source "${library_dir}/load_auth.sh"

declare -i global_option_help=0
declare -a args_without_globals=()
parse_global_options() {
  debug "parse_global_options"
  for argument in "$@"; do
    case "${argument}" in
      # just set a variable, don't change other options
      "--help"|"-h")     global_option_help=1 ;;
      # don't change other options and parameters
      *)                 args_without_globals+=("${argument}")   ;;
    esac
  done
}

show_help() {
  declare help_file="${1}.help"
  # edge case: user called `hopla --help`
  if [[ ! -f "${help_file}" ]]  ; then help_file="${1}/hopla.help" ; fi

  debug "show_help: help_file=${help_file}}"
  cat "${help_file}"
  exit 0
}

declare command_file="$(print_script_dir)"
declare -a subcmd_arguments=()
assign_subcmd_and_arguments() {
  debug "assign_subcmd_and_arguments"
  for argument in "${args_without_globals[@]}" ; do
    if [[ -e "${command_file}/${argument}" ]] ; then
      command_file+="/${argument}"
    else
      subcmd_arguments+=("${argument}")
    fi
  done

  if [[ -d "${command_file}" ]] ; then
    # User didn't finish with full command, they probably want help:
    show_help "${command_file}"
  fi

  if [[ ! -f "${command_file}" ]] ; then
    # User didn't finish with full command, they probably want help:
    echo "could not find the following command file: ${command_file}"
  fi
}


handle_global_options() {
  if (( global_option_help )) ; then
    show_help "${command_file}"
  fi
}


main () {
  parse_global_options "$@"
  assign_subcmd_and_arguments
  handle_global_options

  debug "File to be executed: '${command_file}'"
  debug "Arguments to be passed: '${subcmd_arguments[*]}'"
  debug "# of Arguments to be passed: '${#subcmd_arguments[@]}'"
  "${command_file}" "${subcmd_arguments[@]}"
}
main "$@"


